<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JSON ↔ CSV 更新工具（只限 speech / reading）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px;line-height:1.6}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:18px;margin-bottom:20px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1}
    input[type="file"]{padding:8px;border:1px solid #e5e7eb;border-radius:10px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #111827;background:#111827;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111827}
    .muted{color:#6b7280}.small{font-size:12px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border:1px solid #e5e7eb;padding:8px;vertical-align:top}
    th{background:#f9fafb;position:sticky;top:0;z-index:1}
    .changed{background:#fff7ed}
    pre{white-space:pre-wrap;word-break:break-word;border:1px solid #e5e7eb;border-radius:10px;padding:12px;background:#fafafa;max-height:320px;overflow:auto}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>JSON ↔ CSV 更新工具 <span class="small muted">(僅更新 speech / reading 區塊)</span></h1>
  <p class="small muted">CSV 欄位必須包含 <code>json_path</code>、<code>ab</code>、<code>ch</code>。<br/>
  工具只會處理 JSON 中屬於 <b>speech</b> 或 <b>reading</b> 的路徑，其餘區塊保持原樣。</p>

  <div class="card">
    <h3>1) 上傳檔案</h3>
    <div class="row">
      <div>
        <label>模板 JSON</label><br/>
        <input id="jsonFile" type="file" accept=".json"/>
        <div id="jsonStatus" class="small muted"></div>
      </div>
      <div>
        <label>更新 CSV</label><br/>
        <input id="csvFile" type="file" accept=".csv"/>
        <div id="csvStatus" class="small muted"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>2) 預覽變更</h3>
    <button id="previewBtn">預覽變更</button>
    <span id="previewMsg" class="small muted"></span>
    <div style="max-height:320px;overflow:auto;margin-top:10px">
      <table id="diffTable">
        <thead>
          <tr><th>json_path</th><th>欄位</th><th>原值</th><th>新值</th><th>狀態</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3>3) 套用更新 & 下載</h3>
    <button id="applyBtn">套用更新</button>
    <button id="downloadBtn" class="secondary">下載更新後 JSON</button>
    <p id="applyMsg" class="small muted"></p>
    <h4>結果預覽</h4>
    <pre id="resultPreview"></pre>
  </div>

<script>
let templateJSON=null,csvRows=[],updatedJSON=null,plannedChanges=[];

function setStatus(id,msg,cls="muted"){const el=document.getElementById(id);el.className="small "+cls;el.textContent=msg;}

document.getElementById("jsonFile").addEventListener("change",e=>{
  const f=e.target.files[0];if(!f)return;const r=new FileReader();
  r.onload=ev=>{try{templateJSON=JSON.parse(ev.target.result);setStatus("jsonStatus","已載入 JSON 模板。","");}
    catch(err){setStatus("jsonStatus","JSON 解析錯誤："+err.message,"err");templateJSON=null;}};
  r.readAsText(f,"utf-8");
});

document.getElementById("csvFile").addEventListener("change",e=>{
  const f=e.target.files[0];if(!f)return;
  Papa.parse(f,{header:true,skipEmptyLines:"greedy",encoding:"utf-8",
    complete:(res)=>{csvRows=res.data.map(r=>({json_path:(r.json_path||"").trim(),ab:(r.ab||"").trim(),ch:(r.ch||"").trim()}));
      setStatus("csvStatus",`已載入 ${csvRows.length} 列。`,"");},
    error:(err)=>setStatus("csvStatus","CSV 解析錯誤："+err.message,"err")
  });
});

function parsePath(p){return p.replace(/\]/g,"").split(/[.\[]/g).filter(Boolean);}
function getByPath(root,path){const segs=parsePath(path);let cur=root;for(const s of segs){if(cur==null||!(s in cur))return;cur=cur[s];}return cur;}

function planChanges(){
  plannedChanges=[];if(!templateJSON){setStatus("previewMsg","請先上傳模板 JSON。","warn");return;}
  if(!csvRows.length){setStatus("previewMsg","請先上傳 CSV。","warn");return;}

  for(const row of csvRows){
    const path=row.json_path;if(!path)continue;
    if(!(path.startsWith("speech")||path.startsWith("reading")))continue; // 僅 speech/reading
    const target=getByPath(templateJSON,path);
    if(!target||typeof target!=="object"){plannedChanges.push({path,field:"-",oldVal:"-",newVal:"-",status:"找不到目標"});continue;}
    if(row.ab){const oldAB=target.ab??"";if(row.ab!==oldAB){plannedChanges.push({path,field:"ab",oldVal:oldAB,newVal:row.ab,status:"將更新"});}}
    if(row.ch){const oldCH=target.ch??"";if(row.ch!==oldCH){plannedChanges.push({path,field:"ch",oldVal:oldCH,newVal:row.ch,status:"將更新"});}}
  }
  renderDiffTable(plannedChanges);
  setStatus("previewMsg",`預覽完成：${plannedChanges.filter(r=>r.status==="將更新").length} 項將被更新。`,"");
}

function renderDiffTable(rows){
  const tb=document.querySelector("#diffTable tbody");tb.innerHTML="";
  for(const r of rows){const tr=document.createElement("tr");
    function td(t,c){const el=document.createElement("td");el.textContent=t;if(c)el.className=c;return el;}
    tr.appendChild(td(r.path));tr.appendChild(td(r.field));tr.appendChild(td(r.oldVal,r.status==="將更新"?"changed":""));
    tr.appendChild(td(r.newVal,r.status==="將更新"?"changed":""));tr.appendChild(td(r.status));tb.appendChild(tr);}
}

function applyChanges(){
  if(!templateJSON){setStatus("applyMsg","請先上傳模板 JSON。","warn");return;}
  if(!csvRows.length){setStatus("applyMsg","請先上傳 CSV。","warn");return;}
  if(!plannedChanges.length)planChanges();

  const updated=JSON.parse(JSON.stringify(templateJSON));let applied=0;
  for(const change of plannedChanges){
    if(change.status!=="將更新")continue;
    const obj=getByPath(updated,change.path);if(!obj||typeof obj!=="object")continue;
    if(change.field==="ab"||change.field==="ch"){if(change.newVal&&(change.newVal!==(obj[change.field]??""))){obj[change.field]=change.newVal;applied++;}}
  }
  updatedJSON=updated;
  setStatus("applyMsg",`已套用 ${applied} 項更新。`,"");
  document.getElementById("resultPreview").textContent=JSON.stringify(updatedJSON,null,2);
}

function downloadUpdated(){
  if(!updatedJSON){setStatus("applyMsg","尚未套用更新或無結果可下載。","warn");return;}
  const blob=new Blob([JSON.stringify(updatedJSON,null,2)],{type:"application/json;charset=utf-8"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="updated.json";a.click();URL.revokeObjectURL(a.href);
}

document.getElementById("previewBtn").addEventListener("click",planChanges);
document.getElementById("applyBtn").addEventListener("click",applyChanges);
document.getElementById("downloadBtn").addEventListener("click",downloadUpdated);
</script>
</body>
</html>
